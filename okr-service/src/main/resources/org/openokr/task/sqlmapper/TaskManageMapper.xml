<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.openokr.task.sqlmapper.TaskManageMapper">

    <select id="getTableData" parameterType="java.util.Map" resultType="org.openokr.task.vo.TaskVO">
        SELECT
        t1.id, t1.task_code, t1.task_name, t1.task_status, t1.task_remark, t1.is_deleted, t1.task_start_time,
        t1.task_end_time, t1.jira_label, t1.confirm_user_id, t1.create_user_id, t1.create_ts,t1.update_user_id,
        t1.update_ts
        FROM t_okr_task t1
        <where>
            <if test="vo.searchKey != null and !vo.searchKey.isEmpty()">
                and (ar.task_name LIKE CONCAT('%', #{vo.searchKey }, '%') or ar.task_remark LIKE CONCAT('%', #{vo.searchKey }, '%'))
            </if>
            <if test="vo.queryStartDate != null">
                <![CDATA[AND t1.create_ts >= #{vo.queryStartDate}]]>
            </if>
            <if test="vo.queryStartDate != null">
                <![CDATA[AND t1.create_ts >= #{vo.queryStartDate}]]>
            </if>
            <if test="vo.queryEndDate != null">
                <![CDATA[AND t1.create_ts <= #{vo.queryEndDate}]]>
            </if>
        </where>
        order by create_ts desc
        <if test="page != null" >
            <![CDATA[ limit #{page.pageSize} offset (#{page.recordStart}-1) ]]>
        </if>
    </select>

    <select id="countTableData" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT
          count(t1.*)
        FROM t_okr_task t1
        <where>
            <if test="vo.searchKey != null and !vo.searchKey.isEmpty()">
                and (t1.task_name LIKE CONCAT('%', #{vo.searchKey }, '%') or t1.task_remark LIKE CONCAT('%', #{vo.searchKey }, '%'))
            </if>
            <if test="vo.queryStartDate != null">
                <![CDATA[AND t1.create_ts >= #{vo.queryStartDate}]]>
            </if>
            <if test="vo.queryEndDate != null">
                <![CDATA[AND t1.create_ts <= #{vo.queryEndDate}]]>
            </if>
        </where>
    </select>

    <select id="getMyRenectReportProjectIIds" parameterType="java.util.Map" resultType="java.lang.String">
        SELECT DISTINCT
	      t1.project_id
        FROM
            (
        SELECT
            tta.project_id
        FROM
            T_OKR_DAILY td
            INNER JOIN T_OKR_TASK_APPORTION tta ON td.task_id = tta.task_id
        	INNER JOIN t_okr_task TT ON TTA.task_id = TT.ID
        <where>
            <if test="reportUserId != null and !reportUserId.isEmpty()">
                and td.report_user_id = #{reportUserId}
            </if>
            <if test="reportUserId != null and !reportUserId.isEmpty()">
                and tt.confirm_user_id = #{confirmUserId}
            </if>
        </where>
        ORDER BY
            td.report_day DESC
            ) t1
        <if test="vo.endDate != null">
            <![CDATA[AND ar.create_ts <= #{vo.queryEndDate}]]>
        </if>
    </select>
    <select id="getProjectRelTaskCountInfo" parameterType="java.util.Map" resultType="org.openokr.task.vo.MyTaskCountInfoVO">
        SELECT
            COUNT ( td.* ) relTaskNum,
            COALESCE ( SUM ( td.DURATION ), 0 ) totalDuration
        FROM
            T_OKR_DAILY td
            INNER JOIN t_okr_task_apportion tta ON td.task_id = tta.task_id
        <where>
            <if test="reportUserId != null and !reportUserId.isEmpty()">
               AND td.report_user_id = #{reportUserId}
            </if>
            <if test="projectId != null and !projectId.isEmpty()">
               AND tta.project_id = #{projectId}
            </if>
            <if test="queryStartDate != null">
                <![CDATA[AND td.report_day >= #{reportStartDate}]]>
            </if>
            <if test="endDate != null">
                <![CDATA[AND td.report_day <= #{reportEndDate}]]>
            </if>
        </where>
    </select>
    <select id="countProjectRelUserNum" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT
            COUNT ( ttur.* ) totalUserNum
        FROM
            t_okr_task_apportion tta
            inner join T_OKR_TASK_USER_REL ttur on tta.task_id = ttur.task_id
        WHERE
            <if test="projectId != null and !projectId.isEmpty()">
               AND tta.project_id = #{projectId}
            </if>
    </select>
    <select id="getMyRecentTaskInfo" parameterType="java.util.Map" resultType="org.openokr.task.vo.DailyVO">
        SELECT
            td.*,
            TSU.user_name reportUserName
        FROM
            T_OKR_DAILY td
            INNER JOIN t_okr_sys_user TSU td.report_user_id = TSU.ID
        <where>
            <if test="reportUserId != null and !reportUserId.isEmpty()">
               AND td.report_user_id = #{reportUserId}
            </if>
        </where>
        order by create_ts desc
        <if test="page != null" >
            <![CDATA[ limit 4 offset 0 ]]>
        </if>
    </select>

</mapper>